<div class="container">
  <div class="row">
    <div class="ui-g-12">
      <div class="ui-g-2 mx-0">
        <h2 class="fs-22 mb-0">Entities</h2>
      </div>
      <div class="ui-g-10 mx-0 text-right">
        <span *HasAnyAuthority="['DEDUCTOR_CREATE']">
          <ey-download-template
            [templateName]="'Onboarding template'"
            [templateType]="'onboarding_master'"
          ></ey-download-template>
          <button
            type="button"
            class="ui-button btn-secondary"
            (click)="showDialog($event)"
          >
            <i class="fas fa-upload"></i> Upload
          </button>
          <button
            type="button"
            class="ui-button btn-primary"
            (click)="openDeductorForm(undefined, undefined)"
          >
            <i class="fa fa-plus mr-5"></i> Add New Entity
          </button>
          <button
            type="button"
            class="ui-button btn-secondary"
            (click)="refreshData()"
          >
            <i class="fas fa-sync"></i> Refresh data
          </button>
        </span>
      </div>
    </div>

    <div class="ui-g-12 mb-100" *HasAnyAuthority="['DEDUCTOR_LIST']">
      <div class="p-20 pt-10 border">
        <p-tabView class="table-tab-view" (onChange)="onTabChange($event)">
          <p-tabPanel header="Entities list">
            <p-table
              #dt
              [columns]="selectedColumns"
              [paginator]="true"
              [rows]="5"
              [rowsPerPageOptions]="[5, 10, 20, 30]"
              [totalRecords]="deductorList?.length"
              [value]="deductorList"
              [scrollable]="true"
              scrollHeight="400px"
            >
              <ng-template pTemplate="caption">
                <div class="ui-g mt-0">
                  <div class="ui-g-12 ui-md-4 mx-0">
                    <div style="text-align:left">
                      <p-multiSelect
                        [options]="cols"
                        optionLabel="header"
                        name="selectedColumns"
                        selectedItemsLabel="{0} columns selected"
                        [style]="{ minWidth: '200px' }"
                        [(ngModel)]="selectedColumns"
                        defaultLabel="Choose Columns"
                        ngDefaultControl
                      ></p-multiSelect>
                    </div>
                  </div>
                  <div class="ui-inputgroup ui-inputgroup-cust ui-g-8 mx-0">
                    <div class="relative">
                      <input
                        type="text"
                        pInputText
                        placeholder="Search"
                        (input)="
                          dt.filterGlobal($event.target.value, 'contains')
                        "
                        class="input-ctrl input-search-type"
                      />
                      <button
                        type="submit"
                        class="input-search pi pi-search"
                      ></button>
                    </div>
                  </div>
                </div>
              </ng-template>

              <ng-template pTemplate="header" let-columns>
                <tr>
                  <th
                    *ngFor="let col of columns; let i = index"
                    [pSortableColumn]="col.field"
                    [style.width]="col.width"
                  >
                    {{ col.header }}
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                  </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rowData let-columns="columns">
                <tr>
                  <td
                    *ngFor="let col of columns; let i = index"
                    [style.width]="col.width"
                  >
                    <a
                      href="javascript:void()"
                      *ngIf="col.type === 'initial'"
                      (click)="openDeductorForm('view', rowData.pan)"
                    >
                      {{ rowData[col.field] }}</a
                    >
                    <span *ngIf="col.type === 'date'">{{
                      rowData[col.field] | date: 'dd/MM/yyyy h:mm:ss a'
                    }}</span>
                    <p *ngIf="col.type === 'long-text'" class="ellipse">
                      {{ rowData[col.field] }}
                    </p>
                    <span *HasAnyAuthority="['DEDUCTOR_UPDATE']">
                      <a
                        href="javascript:void(0);"
                        *ngIf="col.type === 'action'"
                        class="text-right"
                        (click)="openDeductorForm('edit', rowData.pan)"
                      >
                        Edit
                      </a>
                      <span
                        *ngIf="col.type === 'action' && rowData.scopeGroup.Tds"
                      >
                        |
                        <a
                          href="javascript:void(0);"
                          class="text-right"
                          (click)="openOnboardingForm(rowData.id, rowData.pan)"
                        >
                          TDS configuration
                        </a>
                      </span>
                      <span
                        *ngIf="col.type === 'action' && rowData.scopeGroup.Tcs"
                      >
                        |
                        <a
                          href="javascript:void(0);"
                          class="text-right"
                          (click)="
                            openOnboardingFormTcs(rowData.id, rowData.pan)
                          "
                        >
                          TCS configuration
                        </a>
                      </span>
                      <!--   <span  *ngIf="col.type === 'action'"
                      >
                        |
                        <a
                          href="javascript:void(0);"
                          class="text-right"
                          (click)="openOnboardingForm26AS(rowData.id, rowData.pan)"
                        >
                          26AS configuration
                        </a>
                      </span> -->
                    </span>
                    <span *ngIf="!col.type">{{ rowData[col.field] }}</span>
                    <p class="ellipse" *ngIf="col.type === 'array'">
                      <span
                        *ngFor="let item of rowData[col.field]"
                        class="mr-10"
                        >{{ item.nature }}</span
                      >
                    </p>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage" let-columns>
                <tr>
                  <td [attr.colspan]="columns.length">
                    No records found
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </p-tabPanel>
          <p-tabPanel header="File processing status">
            <ey-batch-upload-table
              [tableData]="statusList"
              [fileType]="fileTypeOf"
              (year)="getSelectedYear($event)"
            >
            </ey-batch-upload-table>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>
</div>

<!-- Upload pop up -->
<p-dialog
  header="Upload"
  [(visible)]="display"
  [style]="{ width: '800px' }"
  [modal]="true"
  [responsive]="true"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  (onHide)="clearUpload()"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <form [formGroup]="deductorUploadForm">
    <div class="p-20">
      <div
        class="row mx-0 mb-20 "
        *ngIf="!fileLoading && !uploadSuccess && !uploadError"
      ></div>
      <div
        class="no-files m-20"
        *ngIf="!filesExists && !uploadSuccess && !uploadError && !fileLoading"
      >
        <p class="fs-18">
          No files added. Please click add files button to upload files.
        </p>
        <span *ngIf="fileTypeOf == 'LDC_EXCEL'" class="fs-14 mt-20">
          Note: Upload .excel files only.
        </span>
        <span *ngIf="fileTypeOf == 'LDC_PDF'" class="fs-14 mt-20">
          Note: Upload .pdf files only.
        </span>
      </div>
      <div class="text-center my-50" *ngIf="fileLoading">
        <i class="fs-24 fas fa-hourglass-start fa-spin text-success mb-30"></i>
        <p class="fs-16">Your file is being processed. please wait.</p>
      </div>
      <div class="text-center my-50" *ngIf="uploadSuccess">
        <i class="fs-80 fa fa-check-circle text-success mb-30"></i>
        <p class="fs-24">File Uploaded Successfully.</p>
      </div>
      <div class="text-center my-50" *ngIf="uploadError">
        <i class="fs-80 fa fa-times text-danger mb-30"></i>
        <p class="fs-24">Processing failed.</p>
      </div>
      <div
        class="files p-20 ovr-files"
        *ngIf="filesExists && !uploadSuccess && !uploadError && !fileLoading"
      >
        <div class="alert alert-success">
          {{ rawValues.files.length }} has been added successfully. Please click
          upload files to process files.
        </div>
        <div
          class="bg-light mb-10 p-20 row mx-0"
          *ngFor="let file of rawValues.files; let i = index"
        >
          <div class="col-sm-8">
            {{ file.name }}
          </div>
          <div class="col-sm-2">
            {{ formatBytes(file.size) }}
          </div>
          <div class="col-sm-2">
            <button
              type="button"
              class="ui-button btn-secondary"
              (click)="removeFiles(i)"
            >
              <i class="pi pi-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <p-footer *ngIf="!fileLoading && !uploadSuccess && !uploadError">
    <span *ngIf="!filesExists">
      <input
        type="file"
        class="inputfile"
        id="invoicefiles"
        (change)="uploadHandler($event)"
        accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
      />
      <label for="invoicefiles" class="mb-0">Add files</label>
    </span>
    <button
      type="button"
      class="ui-button btn-secondary"
      *ngIf="filesExists"
      (click)="uploadFiles()"
    >
      Upload files
    </button>
  </p-footer>
</p-dialog>
<!--TDS Scope-->
<p-dialog
  [(visible)]="onboardingpopup"
  [style]="{ width: '1000px', height: '600px' }"
  [modal]="true"
  [responsive]="true"
  [scrollable]="true"
  [positionTop]="50"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <div class="scroll-wrapper over-x-hidden">
    <ey-onboarding
      *ngIf="onboardingpopup"
      [deductorPAN]="deductorPan"
      [moduleScope]="TDS"
      (closePopup)="closeOnboardingPopup($event)"
    >
    </ey-onboarding>
  </div>
</p-dialog>
<!--TCS Scope pop up...-->
<p-dialog
  [(visible)]="onboardingpopupTcs"
  [style]="{ width: '1000px', height: '600px' }"
  [modal]="true"
  [responsive]="true"
  [scrollable]="true"
  [positionTop]="50"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <div class="scroll-wrapper over-x-hidden">
    <ey-onboarding-tcs
      *ngIf="onboardingpopupTcs"
      [deductorPAN]="deductorPan"
      (closePopup)="closeOnboardingPopupTcs($event)"
    >
    </ey-onboarding-tcs></div
></p-dialog>

<!-- 26AS scop popUP -->
<p-dialog
  [(visible)]="onboardingpopup26AS"
  [style]="{ width: '1000px', height: '600px' }"
  [modal]="true"
  [responsive]="true"
  [scrollable]="true"
  [positionTop]="50"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <div class="scroll-wrapper over-x-hidden">
    <ey-onboarding26-as
      *ngIf="onboardingpopup26AS"
      [deductorPAN]="deductorPan"
      (closePopup)="closeOnboardingPopup26AS($event)"
    >
    </ey-onboarding26-as></div
></p-dialog>
<!--Add new Entity-->
<p-dialog
  [(visible)]="deductorformpopup"
  [style]="{ width: '1000px', height: '600px' }"
  [modal]="true"
  [responsive]="true"
  [scrollable]="true"
  [positionTop]="50"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <div class="scroll-wrapper over-x-hidden">
    <ey-deductorform
      [deductorInputId]="deductorPan"
      [action]="actionType"
      (closePopup)="closePopup($event)"
      *ngIf="deductorformpopup"
    >
    </ey-deductorform>
  </div>
</p-dialog>

<!--Manage roles pop up and custom Hidden

<p-dialog
  [(visible)]="rolespopup"
  [style]="{ width: '900px', height: '500px' }"
  [modal]="true"
  [responsive]="true"
  [scrollable]="true"
  [positionTop]="50"
  [contentStyle]="{ overflow: 'visible' }"
  [minY]="70"
  [maximizable]="true"
  [baseZIndex]="10000"
>
  <div class="scroll-wrapper over-x-hidden">
    <ey-roles-permissions
      *ngIf="rolespopup && !showRoleForm"
      [deductorPAN]="deductorPan"
      [action]="actionType"
      (closePopup)="closeRolesPopup($event)"
      (manageForm)="roleFormBehaviorHandler($event)"
    >
    </ey-roles-permissions>

    <ey-roles-permission-form
      *ngIf="rolespopup && showRoleForm"
      (listHandler)="roleListBehaviorHandler($event)"
      [formActionType]="roleFormActionType"
      [deductorPan]="deductorPan"
      (manageForm)="roleFormBehaviorHandler($event)"
    >
    </ey-roles-permission-form>
  </div>
</p-dialog>

<ey-customtransformation
  *ngIf="custTransform"
  [custTransform]="custTransform"
  [deductorInputId]="deductorPan"
  (modelStateEmmiter)="closeCustomPopup($event)"
>
</ey-customtransformation>
-->
